@model IEnumerable<webgk.Models.DonHang>

@{
    ViewData["Title"] = "Danh sách đơn hàng";
}

<h2>Danh sách đơn hàng</h2>

@if (!Model.Any())
{
    <p>Không có đơn hàng nào.</p>
}
else
{
    <div class="container-fluid pt-4 px-4">
        <div class="row g-4">
            <div class="col-sm-6 col-xl-3">
                <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                    <i class="fa fa-chart-line fa-3x text-primary"></i>
                    <div class="ms-3">
                        <p class="mb-2">Bán hàng hôm nay</p>
                        <h6 class="mb-0">@ViewBag.TodaySales</h6>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                    <i class="fa fa-chart-bar fa-3x text-primary"></i>
                    <div class="ms-3">
                        <p class="mb-2">Tổng số đơn hàng</p>
                        <h6 class="mb-0">@ViewBag.TotalOrders</h6>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                    <i class="fa fa-chart-area fa-3x text-primary"></i>
                    <div class="ms-3">
                        <p class="mb-2">Doanh thu hôm nay</p>
                        <h6 class="mb-0">@ViewBag.TodayRevenue.ToString("C")</h6>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="bg-light rounded d-flex align-items-center justify-content-between p-4">
                    <i class="fa fa-chart-pie fa-3x text-primary"></i>
                    <div class="ms-3">
                        <p class="mb-2">Tổng doanh thu</p>
                        <h6 class="mb-0">@ViewBag.TotalRevenue.ToString("C")</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid pt-4 px-4">
        <div class="bg-light text-center rounded p-4">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h6 class="mb-0">Đơn hàng gần đây</h6>
                <form class="input-group" onsubmit="event.preventDefault(); searchOrders();">
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm đơn hàng...">
                    <div class="input-group-append">
                        <button class="btn btn-primary" type="submit">Tìm kiếm</button>
                    </div>
                </form>
            </div>
            <div class="table-responsive">
                <table class="table text-start align-middle table-bordered table-hover mb-0" id="ordersTable">
                    <thead>
                        <tr class="text-dark">
                            <th scope="col"><input class="form-check-input" type="checkbox"></th>
                            <th scope="col" onclick="sortTable(1)">Ngày bán</th>
                            <th scope="col" onclick="sortTable(2)">Mã đơn</th>
                            <th scope="col" onclick="sortTable(3)">Mã khách hàng</th>
                            <th scope="col" onclick="sortTable(4)">Tổng tiền</th>
                            <th scope="col" onclick="sortTable(5)">Trạng thái</th>
                            <th scope="col">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Count() > 0)
                        {
                            foreach (var item in Model)
                            {
                                <tr>
                                    <td><input class="form-check-input" type="checkbox"></td>
                                    <td>@item.NgayBan.ToString("dd MMM yyyy")</td>
                                    <td>@item.MaDon</td>
                                    <td>@item.MaKhach</td>
                                    <td>@item.TongTien.ToString("C")</td>
                                    <td>@item.TrangThaiDH</td>
                                    <td>
                                        <button class="btn btn-info btn-sm" onclick="viewDetail(@item.MaDon)">Chi tiết</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteDonHang(@item.MaDon)">Xóa</button>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="7" class="text-center">Không có đơn hàng nào</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

<script>
    function searchOrders() {
        var input, filter, table, tr, td, i, j, txtValue;
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        table = document.getElementById("ordersTable");
        tr = table.getElementsByTagName("tr");

        for (i = 1; i < tr.length; i++) {
            tr[i].style.display = "none";
            td = tr[i].getElementsByTagName("td");
            for (j = 0; j < td.length; j++) {
                if (td[j]) {
                    txtValue = td[j].textContent || td[j].innerText;
                    if (txtValue.toUpperCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                        break;
                    }
                }
            }
        }
    }

    function sortTable(n) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("ordersTable");
        switching = true;
        dir = "asc";

        while (switching) {
            switching = false;
            rows = table.rows;

            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n].innerText.toLowerCase();
                y = rows[i + 1].getElementsByTagName("TD")[n].innerText.toLowerCase();

                if (dir == "asc") {
                    if (x > y) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir == "desc") {
                    if (x < y) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }

    function viewDetail(id) {
        window.location.href = `/DonHang/Details/${id}`;
    }

    function deleteDonHang(id) {
        if (confirm('Bạn có chắc chắn muốn xóa đơn hàng này?')) {
            fetch(`/api/DonHangApi/${id}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        alert('Đơn hàng đã được xóa thành công!');
                        window.location.reload();
                    } else {
                        alert('Không thể xóa đơn hàng này.');
                    }
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }
    }
</script>
